<!DOCTYPE html><html ng-app="newshub"><meta charset="utf-8"><title>NewsHub</title><meta name="Description" content="a simple post and reply app"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width"><link href="components/css/bootstrap.min.css" rel="stylesheet"><!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><style>.alerts {
  position: fixed;
  z-index: 1;
  top: 2em;
  right: 3em;
  left: 3em;
}
#newshub {
  margin-top: 1em;
}
.l-align-right {
  float: right;
}
.panel-heading a {
  color: #fff;
}
.post-reply-list {
  list-style-type: none;
}
.post-reply,
.post {
  margin-left: 1em;
}
.up-vote-icon {
  width: 1em;
  float: left;
}
a.logo:hover {
  text-decoration: none;
}
#list-view {
  max-width: 50em;
}
#login-view {
  max-width: 43em;
}
#last-updated {
  font-style: italic;
}
</style><script src="components/js/angular.min.js"></script><script src="components/js/angular-route.min.js"></script><script src="components/js/angular-cookies.min.js"></script><script>(function() {
  var app;

  app = angular.module('newshub', ['ngRoute', 'ngCookies']);

  window.callFn = function(fn) {
    if ('function' === typeof fn) {
      return fn.apply(null, Array.prototype.slice.call(arguments, 1));
    }
  };

  app.config(function($routeProvider) {
    $routeProvider.when('/', {
      controller: 'ListController',
      templateUrl: 'views/list'
    }).when('/login', {
      controller: 'LoginController',
      templateUrl: 'views/login'
    }).when('/post/:id', {
      controller: 'PostController',
      templateUrl: 'views/post'
    }).when('/submit', {
      controller: 'SubmitController',
      templateUrl: 'views/submit'
    }).when('/profile/:id', {
      controller: 'ProfileController',
      templateUrl: 'views/profile'
    }).otherwise({
      redirectTo: '/'
    });
  });

  app.run(function($rootScope, $location, userService, alertService) {
    var user;
    $rootScope.$on('$routeChangeSuccess', function() {
      return alertService.clear();
    });
    user = userService.getUser();
    $rootScope.logout = function() {
      return userService.logout(function(err, date) {
        return alertService.success('Signed out successfully. Redirecting...', 2000, function() {
          $location.path('/');
          return $location.replace();
        });
      });
    };
    return userService.login('a@b', 'a', function(err) {
      if (err) {
        return userService.signup('a@b', 'test', 'a');
      }
    });
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.controller('LoginController', function($scope, $location, userService, alertService) {
    $scope.submitLogin = function(email, password) {
      alertService.clear();
      return userService.login(email, password, function(err, user) {
        if (err) {
          return alertService.error(err.message, -1);
        } else {
          return alertService.success('Logged in successfully. Redirecting...', 2000, function() {
            $location.path('/');
            return $location.replace();
          });
        }
      });
    };
    return $scope.submitSignUp = function(email, username, password) {
      alertService.clear();
      return userService.signup(email, username, password, function(err, data) {
        if (err) {
          return alertService.error(err.message, -1);
        } else {
          return alertService.success('Signed up successfully. Redirecting...', 2000, function() {
            $location.path('/');
            return $location.replace();
          });
        }
      });
    };
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.controller('ListController', function($scope, $routeParams, $rootScope, $location, postService, alertService) {
    var page, type;
    page = $routeParams.page || 1;
    type = $routeParams.sort || 'top';
    postService.list(type, page, function(err, data) {
      return $scope.data = data;
    });
    $scope.nextPage = function() {
      $location.search('page', page + 1);
      return $location.replace();
    };
    return $scope.upVotePost = function(post) {
      post.votes = post.votes || [];
      return postService.vote(post.id, post.votes, $rootScope.user.id, function(err, data) {
        if (err) {
          return alertService.error(err.message);
        } else {
          post.vcnt = post.votes.length;
          return alertService.success('Vote submitted.');
        }
      });
    };
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.controller('PostController', function($scope, $routeParams, $rootScope, postService, alertService) {
    var getPost, sortReplies;
    sortReplies = function(post) {
      var id, replies, reply, _ref;
      replies = [];
      _ref = post.children;
      for (id in _ref) {
        reply = _ref[id];
        replies.push(reply);
      }
      replies = replies.map(sortReplies);
      post.children = replies.sort(function(a, b) {
        return (a.vcnt || 0) < (b.vcnt || 0);
      });
      return post;
    };
    getPost = function(done) {
      return postService.getPost($routeParams.id, function(err, data) {
        $scope.post = sortReplies(data);
        return callFn(done, err, data);
      });
    };
    getPost();
    $scope.submitReply = function(rootId, parentId, postTitle, replyText) {
      if ('RE:' !== postTitle.substr(0, 3)) {
        postTitle = 'RE:' + postTitle;
      }
      return postService.reply(rootId, parentId, postTitle, replyText, function(err, data) {
        if (err) {
          return alertService.error(err.message);
        } else {
          return alertService.success('Reply submitted. Refreshing...', 0, function() {
            $scope.replyText = '';
            return getPost();
          });
        }
      });
    };
    return $scope.upVotePost = function(post) {
      post.votes = post.votes || [];
      return postService.vote(post.id, post.votes, $rootScope.user.id, function(err, data) {
        if (err) {
          return alertService.error(err.message);
        } else {
          post.vcnt = post.votes.length;
          return alertService.success('Vote submitted.');
        }
      });
    };
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.controller('SubmitController', function($scope, $location, userService, postService, alertService) {
    if (!userService.getUser()) {
      $location.path('/login');
      $location.replace();
      return;
    }
    $scope.urlTextToggle = "url";
    return $scope.submitPost = function(title, url, text) {
      if ("url" === $scope.urlTextToggle) {
        text = "";
      } else {
        url = "";
      }
      return postService.create(title, url, text, function(err, data) {
        if (err) {
          return alertService.error(err.message);
        } else {
          return alertService.success('Post submitted. Redirecting...', 0, function() {
            $location.path('/');
            $location.search('sort', 'new');
            return $location.replace();
          });
        }
      });
    };
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.controller('ProfileController', function($scope, $routeParams, userService) {
    var getProfile;
    getProfile = function(done) {
      return userService.getProfile($routeParams.id, function(err, data) {
        return $scope.profile = data;
      });
    };
    return getProfile();
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.service('urlService', function() {
    var urlService;
    urlService = {};
    urlService.list = function(type, page) {
      return "/static/list/" + type + "/" + (page && page > 1 ? page : 'index') + ".json";
    };
    urlService.profile = function(id) {
      return "/static/profile/" + id + ".json";
    };
    urlService.getPost = function(id) {
      return "/static/post/" + id + ".json";
    };
    urlService.createPost = function() {
      return '/api/post/create';
    };
    urlService.replyPost = function() {
      return '/api/post/reply';
    };
    urlService.votePost = function() {
      return '/api/post/vote';
    };
    urlService.login = function() {
      return '/api/auth/login';
    };
    urlService.signUp = function() {
      return '/api/auth/signup';
    };
    urlService.logout = function() {
      return '/api/auth/logout';
    };
    return urlService;
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.service('userService', function($http, $rootScope, urlService) {
    var userService;
    userService = {};
    userService.setUser = function(uid, uname) {
      localStorage.setItem('uid', uid);
      localStorage.setItem('uname', uname);
      return $rootScope.user = {
        id: uid,
        name: uname
      };
    };
    userService.getUser = function() {
      var uid, user;
      if ($rootScope.user) {
        user = $rootScope.user;
      } else if (uid = localStorage.getItem('uid')) {
        user = {
          id: uid,
          name: localStorage.getItem('uname')
        };
        $rootScope.user = user;
      }
      return user;
    };
    userService.clearUser = function() {
      localStorage.removeItem('uid');
      localStorage.removeItem('uname');
      return $rootScope.user = {};
    };
    userService.login = function(email, password, done) {
      var payload;
      payload = {
        email: email,
        password: password
      };
      return $http.post(urlService.login(), payload).success(function(data) {
        if (data.success) {
          userService.setUser(data.uid, data.uname);
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    userService.logout = function(done) {
      return $http.get(urlService.logout()).success(function(data) {
        if (data.success) {
          userService.clearUser();
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    userService.signup = function(email, username, password, done) {
      var payload;
      payload = {
        email: email,
        username: username,
        password: password
      };
      return $http.post(urlService.signUp(), payload).success(function(data) {
        if (data.success) {
          userService.setUser(data.uid, data.uname);
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    userService.getProfile = function(id, done) {
      return $http.get(urlService.profile(id)).success(function(data) {
        return callFn(done, null, data);
      });
    };
    return userService;
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.service('postService', function($http, urlService) {
    var postService;
    postService = {};
    postService.create = function(title, url, text, done) {
      var payload;
      payload = {
        title: title,
        url: url,
        text: text
      };
      return $http.post(urlService.createPost(), payload).success(function(data) {
        if (data.success) {
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    postService.reply = function(rootId, parentId, title, text, done) {
      var payload;
      payload = {
        rootId: rootId,
        parentId: parentId,
        title: title,
        text: text
      };
      return $http.post(urlService.replyPost(), payload).success(function(data) {
        if (data.success) {
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    postService.vote = function(postId, votes, userId, done) {
      var payload;
      userId = '' + userId;
      if (-1 !== votes.indexOf(userId)) {
        return callFn(done, new Error('Already voted.'));
      } else {
        votes.push(userId);
      }
      payload = {
        postId: postId
      };
      return $http.post(urlService.votePost(), payload).success(function(data) {
        if (data.success) {
          return callFn(done, null, data);
        } else {
          return callFn(done, new Error(data.msg));
        }
      });
    };
    postService.list = function(type, page, done) {
      return $http.get(urlService.list(type, page)).success(function(data) {
        return callFn(done, null, data);
      });
    };
    postService.getPost = function(id, done) {
      return $http.get(urlService.getPost(id)).success(function(data) {
        return callFn(done, null, data);
      });
    };
    return postService;
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.service('alertService', function($rootScope, $timeout) {
    var alert, alertService, defaultTimeout, timeout;
    alertService = {};
    timeout = {};
    alertService.defaultTimeout = defaultTimeout = 2000;
    alert = function(target, message, time, done) {
      $rootScope.alerts[target] = message;
      time = time || defaultTimeout;
      if (time > 0) {
        $timeout.cancel(timeout[target]);
        timeout[target] = $timeout((function() {
          return $rootScope.alerts[target] = '';
        }), time);
        return timeout[target]["finally"](done);
      } else {
        return callFn(done, null);
      }
    };
    alertService.success = function(message, time, done) {
      return alert('alertSuccess', message, time, done);
    };
    alertService.error = function(message, time, done) {
      return alert('alertDanger', message, time, done);
    };
    alertService.clear = function() {
      var k, t, _results;
      $rootScope.alerts = {};
      _results = [];
      for (k in timeout) {
        t = timeout[k];
        _results.push($timeout.cancel(t));
      }
      return _results;
    };
    return alertService;
  });

}).call(this);
</script><script>(function() {
  var app;

  app = angular.module('newshub');

  app.filter('brackets', function() {
    return function(value) {
      if (value) {
        return '(' + value + ')';
      } else {
        return '';
      }
    };
  });

}).call(this);
</script></html><body id="newshub"><div class="alerts"><div ng-if="alerts.alertSuccess" class="alert alert-success">{{alerts.alertSuccess}}</div><div ng-if="alerts.alertDanger" class="alert alert-danger">{{alerts.alertDanger}}</div></div><div ng-view></div><script type="text/ng-template" id="views/list"><div id="list-view" class="container"><div class="row clearfix"><div class="col-md-12 column"><div class="panel panel-primary"><div class="panel-heading"><a href="#/" class="logo">NewsHub</a> | <a href="#/?sort=new">new</a> | <a href="#/?sort=reply">comments</a> | <a href="#/submit">Submit</a><div ng-if="user.id" class="l-align-right"><a href="#/profile/{{user.id}}">{{ user.name }}</a> | <a href="javascript: void(0)" ng-click="logout()">Sign out</a></div><div ng-if="!user.id" class="l-align-right"><a href="#/login">Sign in</a></div></div><ul class="list-group"></ul><li ng-repeat="post in data.list" class="list-group-item"><div class="up-vote-icon"><a href="javascript:void(0)" ng-click="upVotePost(post)"><small>&#9650;</small></a></div><div ng-if="data.type != 'reply'" class="post"><a href="{{post.url || '#/post/' + post.id}}" class="list-group-item-heading">{{post.title}}</a> {{post.src | brackets}}<div class="list-group-item-text">{{post.vcnt || 0}} points by <a href="#/profile/{{post.authorId}}">{{post.author}}</a> | {{post.ccnt || 0}} <a href="#/post/{{post.id}}">comments</a></div></div><div ng-if="data.type == 'reply'" class="post"><a href="{{post.url || '#/post/' + post.id}}" class="list-group-item-heading">{{post.title}}</a> by <a href="#/profile/{{post.authorId}}">{{post.author}}</a><div class="list-group-item-text">{{post.text}}</div></div></li><li ng-if="data.page &lt; 5" class="list-group-item"><div class="list-group-item-text"><a href="javascript:void(0)" ng-click="nextPage()">More</a></div></li><div class="panel-footer"><div id="last-updated">Last updated at {{data.updateDt | date:"hh:mm"}} </div></div></div></div></div></div></script><script type="text/ng-template" id="views/reply/tree"><div class="up-vote-icon"><a href="javascript:void(0)" ng-click="upVotePost(reply)"><small>&#9650;</small></a></div><div class="post-reply">{{reply.author}} | <a href="#/post/{{reply.id}}">Reply</a><div class="post-reply-text">{{reply.text}}</div></div><ul ng-if="reply.children" class="post-reply-list"><li ng-repeat="(key, reply) in reply.children" ng-include="'views/reply/tree'" class="post-reply"></li></ul></script><script type="text/ng-template" id="views/post"><div id="post-view" class="container"><div class="row clearfix"><div class="col-md-12 column"><div class="panel panel-primary"><div class="panel-heading"><a href="#/" class="logo">NewsHub</a> | <a href="#/?sort=new">new</a> | <a href="#/?sort=reply">comments</a> | <a href="#/submit">Submit</a><div ng-if="user.id" class="l-align-right"><a href="#/profile/{{user.id}}">{{ user.name }}</a> | <a href="javascript: void(0)" ng-click="logout()">Sign out</a></div><div ng-if="!user.id" class="l-align-right"><a href="#/login">Sign in</a></div></div><div class="panel-body"><div class="up-vote-icon"><a href="javascript:void(0)" ng-click="upVotePost(post)"><small>&#9650;</small></a></div><div class="post"><a href="{{post.url}}">{{post.title}}</a> {{post.src | brackets}}<div>{{post.vcnt || 0}} points by <a href="#/profile/post.authorId">{{post.author}}</a> | {{post.ccnt || 0}} comments</div><div ng-if="post.text" class="post-text">{{post.text}}</div><div ng-if="post.rootId != post.id"><a href="#/post/{{post.rootId}}">Root</a> | <a href="#/post/{{post.parentId}}">Parent</a></div></div><form role="form"><div class="form-group"><div class="row"><div class="col-xs-12"><textarea id="inputReply" rows="6" columns="6" ng-model="replyText" class="form-control"></textarea></div></div><button type="submit" ng-click="submitReply(post.rootId, post.id, post.title, replyText)" class="btn btn-default">Add reply</button></div></form></div><ul ng-repeat="(key, reply) in post.children" class="post-reply-list"><li ng-include="'views/reply/tree'"></li></ul><div class="panel-footer"><div id="last-updated">Last updated at {{post.updateDt | date:"hh:mm"}} </div></div></div></div></div></div></script><script type="text/ng-template" id="views/login"><div id="login-view" class="container"><div class="row clearfix"><div class="col-md-12 column"><div class="page-header"><h1><a href="#/" class="logo">NewsHub</a> <small>Login</small></h1></div><form role="form" class="form-horizontal"><div class="form-group"><label for="inputEmail" class="col-sm-2 control-label">Email</label><div class="col-sm-10"><input id="inputEmail" type="email" ng-model="email" class="form-control"></div></div><div class="form-group"><label for="inputPassword" class="col-sm-2 control-label">Password</label><div class="col-sm-10"><input id="inputPassword" type="password" ng-model="password" class="form-control"></div></div><div class="form-group"><div class="col-sm-offset-2 col-sm-10"><button type="submit" ng-click="submitLogin(email, password)" class="btn btn-default">Sign in</button></div></div></form><div class="page-header"><h1><small>Register</small></h1></div><form role="form" class="form-horizontal"><div class="form-group"><label for="inputEmail" class="col-sm-2 control-label">Email</label><div class="col-sm-10"><input id="inputEmail" type="email" ng-model="email" class="form-control"></div></div><div class="form-group"><label for="inputUsername" class="col-sm-2 control-label">User Name</label><div class="col-sm-10"><input id="inputUsername" type="text" ng-model="username" class="form-control"></div></div><div class="form-group"><label for="inputPassword" class="col-sm-2 control-label">Password</label><div class="col-sm-10"><input id="inputPassword" type="password" ng-model="password" class="form-control"></div></div><div class="form-group"><div class="col-sm-offset-2 col-sm-10"><button type="submit" ng-click="submitSignUp(email, username, password)" class="btn btn-default">Sign Up</button></div></div></form></div></div></div></script><script type="text/ng-template" id="views/submit"><div id="submit-view" class="container"><div class="row clearfix"><div class="col-md-12 column"><div class="panel panel-primary"><div class="panel-heading"><a href="#/" class="logo">NewsHub</a> | <a href="#/?sort=new">new</a> | <a href="#/?sort=reply">comments</a> | <a href="#/submit">Submit</a><div ng-if="user.id" class="l-align-right"><a href="#/profile/{{user.id}}">{{ user.name }}</a> | <a href="javascript: void(0)" ng-click="logout()">Sign out</a></div><div ng-if="!user.id" class="l-align-right"><a href="#/login">Sign in</a></div></div><div class="panel-body"><div class="col-md-6 col-md-offset-2"></div><form role="form" class="form-horizontal"><div class="col-lg-8"><div class="form-group"><label for="inputTitle" class="col-md-2">title</label><div class="col-md-9"><input id="inputTitle" type="text" ng-model="title" class="form-control"></div></div><div class="form-group"><div class="col-md-9"><div class="radio-inline"><label><input type="radio" name="urlTextToggle" ng-model="urlTextToggle" value="url"> url</label></div><div class="radio-inline"><label><input type="radio" name="urlTextToggle" ng-model="urlTextToggle" value="text"> text</label></div></div></div><div ng-show="urlTextToggle === 'url'" class="form-group"><div class="col-md-9"><input id="inputUrl" type="text" ng-model="url" class="form-control"></div></div><div ng-show="urlTextToggle === 'text'" class="form-group"><div class="col-md-9"><textarea id="inputText" rows="6" ng-model="text" class="form-control"></textarea></div></div><div class="form-group"><div class="col-md-offset-2 col-md-12"><button type="submit" ng-click="submitPost(title, url, text)" class="btn btn-default">Submit</button></div></div></div></form></div></div></div></div></div></script><script type="text/ng-template" id="views/profile">under constuction
{{profile}}</script></body>